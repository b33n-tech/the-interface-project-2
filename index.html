<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Sculptor</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;

// Icônes
const Upload = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>;
const Trash2 = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
const Edit3 = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>;
const Plus = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const Save = () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>;
const FolderOpen = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>;

// Composant graphique
const ChartBlock = ({data}) => {
    const canvasRef = useRef(null);

    useEffect(()=>{
        if(!canvasRef.current) return;
        const ctx = canvasRef.current.getContext('2d');
        if(!ctx) return;

        let chartData = {};
        if(data.chart==='bar'){
            chartData = {
                type:'bar',
                data:{
                    labels: data.value.map(v=>v[0]),
                    datasets:[{label:data.title, data:data.value.map(v=>v[1]), backgroundColor:'rgba(59,130,246,0.7)'}]
                },
                options:{responsive:true, plugins:{legend:{display:false}}}
            };
        }else if(data.chart==='pie'){
            chartData = {
                type:'pie',
                data:{
                    labels: data.value.map(v=>v[0]),
                    datasets:[{label:data.title, data:data.value.map(v=>v[1]), backgroundColor:['#3B82F6','#F97316','#EF4444','#10B981','#8B5CF6','#F59E0B','#EC4899']}]
                },
                options:{responsive:true}
            };
        }else return;

        const chartInstance = new Chart(ctx, chartData);
        return ()=> chartInstance.destroy();
    },[data]);

    return <canvas ref={canvasRef} height="150"></canvas>;
};

const DataSculptor = () => {
    const [file,setFile] = useState(null);
    const [data,setData] = useState([]);
    const [columns,setColumns] = useState([]);
    const [blocks,setBlocks] = useState([]);
    const [template,setTemplate] = useState(null);
    const [showModifyPanel,setShowModifyPanel] = useState(false);
    const [showAddPanel,setShowAddPanel] = useState(false);
    const [selectedBlock,setSelectedBlock] = useState(null);
    const [formData,setFormData] = useState({title:'',type:'number',column:'',operation:'sum',chart:'none'});
    const [error,setError] = useState(null);
    const [successMessage,setSuccessMessage] = useState(null);
    const fileInputRef = useRef(null);
    const templateInputRef = useRef(null);

    const detectColumnType=(values)=>{
        const nonNull = values.filter(v=>v!==null && v!==undefined && v!=='');
        if(nonNull.length===0) return 'text';
        const numCount = nonNull.filter(v=>!isNaN(parseFloat(v)) && isFinite(v)).length;
        if(numCount/nonNull.length>0.8) return 'number';
        const uniqueValues = [...new Set(nonNull.map(v=>String(v).toLowerCase()))];
        if(uniqueValues.length<nonNull.length*0.5 && uniqueValues.length<20) return 'category';
        return 'text';
    };

    const generateKPIs=(dataRows,cols)=>{
        let kpis=[];
        let id=0;
        cols.forEach(col=>{
            const values = dataRows.map(r=>r[col]).filter(v=>v!==null && v!==undefined && v!=='');
            const type = detectColumnType(values);
            if(type==='number'){
                const nums = values.map(v=>parseFloat(v));
                kpis.push({id:id++,title:`Total ${col}`,type:'number',value:nums.reduce((a,b)=>a+b,0).toFixed(2),source:{column:col,operation:'sum'}});
                kpis.push({id:id++,title:`Moyenne ${col}`,type:'number',value:(nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2),source:{column:col,operation:'avg'}});
            }
            if(type==='category'){
                const counts={};values.forEach(v=>counts[v]=(counts[v]||0)+1);
                const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
                kpis.push({id:id++,title:`Distribution ${col}`,type:'list',value:sorted.slice(0,10),source:{column:col,operation:'distribution'},chart:'bar'});
            }
        });
        kpis.push({id:id++,title:'Nombre total de lignes',type:'number',value:dataRows.length,source:{operation:'count'}});
        return kpis;
    };

    const calculateKPI=(form,sourceData=data)=>{
        const {column,operation,type}=form;
        if(operation==='count') return sourceData.length;
        const values=sourceData.map(r=>r[column]).filter(v=>v!==null && v!==undefined && v!=='');
        if(type==='number'){
            const nums=values.map(v=>parseFloat(v)).filter(n=>!isNaN(n));
            if(operation==='sum') return nums.reduce((a,b)=>a+b,0).toFixed(2);
            if(operation==='avg') return (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2);
            if(operation==='max') return Math.max(...nums).toFixed(2);
            if(operation==='min') return Math.min(...nums).toFixed(2);
        }
        if(type==='list' || operation==='distribution'){
            const counts={};values.forEach(v=>counts[v]=(counts[v]||0)+1);
            return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        }
        return 0;
    };

    const applyTemplateToData=(templateBlocks,newData)=>{
        return templateBlocks.map(b=>({...b,value:calculateKPI({...b.source,type:b.type},newData)}));
    };

    const handleFileUpload=(e)=>{
        const uploadedFile=e.target.files[0];if(!uploadedFile) return;
        setError(null);setSuccessMessage(null);
        const reader=new FileReader();
        reader.onload=(event)=>{
            try{
                const wb = XLSX.read(new Uint8Array(event.target.result), {type:'array'});
                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(jsonData.length===0){setError("Fichier vide");return;}
                const cols=Object.keys(jsonData[0]);
                setData(jsonData);setColumns(cols);setFile(uploadedFile);
                if(template){
                    const newBlocks = applyTemplateToData(template.blocks,jsonData);
                    setBlocks(newBlocks);setSuccessMessage(`✅ Template appliqué !`);
                }else{
                    const generatedKPIs = generateKPIs(jsonData,cols);
                    setBlocks(generatedKPIs);
                }
            }catch(err){setError(err.message);}
        };
        reader.readAsArrayBuffer(uploadedFile);
    };

    const handleAdd=()=>{
        setFormData({title:'',type:'number',column:columns[0]||'',operation:'sum',chart:'none'});
        setShowAddPanel(true);
    };

    const handleModify=(id)=>{
        const b = blocks.find(b=>b.id===id);if(!b) return;
        setSelectedBlock(id);
        setFormData({title:b.title,type:b.type,column:b.source?.column||columns[0]||'',operation:b.source?.operation||'sum',chart:b.chart||'none'});
        setShowModifyPanel(true);
    };

    const handleSaveAdd=()=>{
        if(!formData.title || !formData.column){setError("Titre et colonne requis");return;}
        const value=calculateKPI(formData);
        const newBlock={id:blocks.length?Math.max(...blocks.map(b=>b.id))+1:0,...formData,value,source:{column:formData.column,operation:formData.operation}};
        setBlocks([...blocks,newBlock]);setShowAddPanel(false);setError(null);
    };

    const handleSaveModify=()=>{
        if(!formData.title || !formData.column){setError("Titre et colonne requis");return;}
        const value=calculateKPI(formData);
        const newBlock={id:selectedBlock,...formData,value,source:{column:formData.column,operation:formData.operation}};
        setBlocks(blocks.map(b=>b.id===selectedBlock?newBlock:b));setShowModifyPanel(false);setSelectedBlock(null);setError(null);
    };

    const handleDelete=(id)=>{
        setBlocks(blocks.filter(b=>b.id!==id));
    };

    const handleSaveTemplate=()=>{
        const templateData={name:`Template ${new Date().toLocaleDateString()}`,timestamp:new Date().toISOString(),blocks:blocks.map(b=>({id:b.id,title:b.title,type:b.type,source:b.source,chart:b.chart})),expectedColumns:columns};
        setTemplate(templateData);
        const blob = new Blob([JSON.stringify(templateData,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');a.href=url;a.download='dashboard-template.json';a.click();
        setSuccessMessage('✅ Template sauvegardé !');setTimeout(()=>setSuccessMessage(null),5000);
    };

    const handleLoadTemplate=(e)=>{
        const file=e.target.files[0];if(!file) return;
        const reader=new FileReader();
        reader.onload=(event)=>{
            try{
                const t=JSON.parse(event.target.result);
                setTemplate(t);
                if(data.length>0)setBlocks(applyTemplateToData(t.blocks,data));
                setSuccessMessage('✅ Template chargé !');setTimeout(()=>setSuccessMessage(null),5000);
            }catch(err){setError("Erreur template");}
        };
        reader.readAsText(file);
    };

    const renderBlock=(b)=>{
        return (
            <div key={b.id} className="relative bg-white p-6 rounded-lg border border-gray-200 hover:shadow-lg">
                <div className="absolute top-2 right-2 flex gap-2 opacity-0 hover:opacity-100 transition-opacity">
                    <button onClick={()=>handleModify(b.id)} className="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2"><Edit3/></button>
                    <button onClick={()=>handleDelete(b.id)} className="bg-red-500 hover:bg-red-600 text-white rounded-full p-2"><Trash2/></button>
                </div>
                <div className="text-sm text-gray-500 mb-2">{b.title}</div>
                {b.type==='number' && <div className="text-3xl font-bold text-gray-800">{b.value}</div>}
                {b.type==='list' && (b.chart==='bar'||b.chart==='pie') && <ChartBlock data={b}/>}
            </div>
        );
    };

    const renderFormPanel=(isModify)=>(
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-lg w-full">
                <h2 className="text-2xl font-bold mb-6">{isModify?'Modifier':'Ajouter'}</h2>
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium mb-2">Titre</label>
                        <input type="text" value={formData.title} onChange={e=>setFormData({...formData,title:e.target.value})} className="w-full px-3 py-2 border rounded-lg"/>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Type</label>
                        <select value={formData.type} onChange={e=>setFormData({...formData,type:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                            <option value="number">Nombre</option>
                            <option value="list">Liste</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Colonne</label>
                        <select value={formData.column} onChange={e=>setFormData({...formData,column:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                            {columns.map(c=><option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Opération</label>
                        <select value={formData.operation} onChange={e=>setFormData({...formData,operation:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                            <option value="sum">Somme</option>
                            <option value="avg">Moyenne</option>
                            <option value="max">Maximum</option>
                            <option value="min">Minimum</option>
                            <option value="count">Comptage</option>
                            <option value="distribution">Distribution</option>
                        </select>
                    </div>
                    {formData.type==='list' && (
                        <div>
                            <label className="block text-sm font-medium mb-2">Graphique</label>
                            <select value={formData.chart} onChange={e=>setFormData({...formData,chart:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                <option value="bar">Barres</option>
                                <option value="pie">Camembert</option>
                                <option value="none">Aucun</option>
                            </select>
                        </div>
                    )}
                </div>
                <div className="flex gap-3 mt-6">
                    <button onClick={isModify?handleSaveModify:handleSaveAdd} className="flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600">OK</button>
                    <button onClick={()=>isModify?setShowModifyPanel(false):setShowAddPanel(false)} className="flex-1 bg-gray-300 px-4 py-3 rounded-lg">Annuler</button>
                </div>
            </div>
        </div>
    );

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-8">
            <div className="max-w-7xl mx-auto">
                <h1 className="text-3xl font-bold mb-4">Data Sculptor</h1>
                <div className="flex gap-4 mb-4">
                    <button onClick={()=>fileInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg"><Upload/>Upload fichier</button>
                    <input ref={fileInputRef} type="file" className="hidden" onChange={handleFileUpload} accept=".csv,.xlsx"/>
                    <button onClick={()=>templateInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg"><FolderOpen/>Charger template</button>
                    <input ref={templateInputRef} type="file" className="hidden" onChange={handleLoadTemplate} accept=".json"/>
                    <button onClick={handleAdd} className="flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg"><Plus/>Ajouter KPI</button>
                    <button onClick={handleSaveTemplate} className="flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg"><Save/>Sauvegarder template</button>
                </div>
                {error && <div className="text-red-600 mb-4">{error}</div>}
                {successMessage && <div className="text-green-600 mb-4">{successMessage}</div>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {blocks.map(renderBlock)}
                </div>
            </div>
            {showAddPanel && renderFormPanel(false)}
            {showModifyPanel && renderFormPanel(true)}
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<DataSculptor/>);
</script>
</body>
</html>
