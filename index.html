<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Sculptor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useRef } = React;

const Upload = () => <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>;
const FolderOpen = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>;
const Edit3 = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>;
const Trash2 = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const Save = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>;
const X = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;

const DataSculptor = () => {
    const [file, setFile] = useState(null);
    const [data, setData] = useState([]);
    const [columns, setColumns] = useState([]);
    const [blocks, setBlocks] = useState([]);
    const [template, setTemplate] = useState(null);
    const [selectedBlock, setSelectedBlock] = useState(null);
    const [showModifyPanel, setShowModifyPanel] = useState(false);
    const [showAddPanel, setShowAddPanel] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);

    const fileInputRef = useRef(null);
    const templateInputRef = useRef(null);

    const [formData, setFormData] = useState({ title: '', type: 'number', column: '', operation: 'sum' });

    const detectColumnType = (values) => {
        const nonNull = values.filter(v => v !== null && v !== undefined && v !== '');
        if (nonNull.length === 0) return 'text';
        const numCount = nonNull.filter(v => !isNaN(parseFloat(v)) && isFinite(v)).length;
        if (numCount / nonNull.length > 0.8) return 'number';
        const uniqueValues = [...new Set(nonNull.map(v => String(v).toLowerCase()))];
        if (uniqueValues.length < nonNull.length * 0.5 && uniqueValues.length < 20) return 'category';
        return 'text';
    };

    const calculateKPI = ({ column, operation, type }, sourceData) => {
        const useData = sourceData || data;
        if (operation === 'count') return useData.length;

        const values = useData.map(row => row[column]).filter(v => v !== null && v !== undefined && v !== '');
        if (type === 'number') {
            const nums = values.map(v => parseFloat(v)).filter(n => !isNaN(n));
            if (operation === 'sum') return nums.reduce((a, b) => a + b, 0).toFixed(2);
            if (operation === 'avg') return (nums.reduce((a, b) => a + b, 0)/nums.length).toFixed(2);
            if (operation === 'max') return Math.max(...nums).toFixed(2);
            if (operation === 'min') return Math.min(...nums).toFixed(2);
        }
        if (type === 'list' || operation === 'distribution') {
            const counts = {};
            values.forEach(v => counts[v] = (counts[v] || 0) + 1);
            return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        }
        return 0;
    };

    const generateKPIs = (dataRows, cols) => {
        const kpis = [];
        let id = 0;
        const columnTypes = cols.map(col => ({ name: col, type: detectColumnType(dataRows.map(r => r[col])) }));

        columnTypes.forEach(col => {
            const values = dataRows.map(r => r[col.name]).filter(v => v !== null && v !== undefined && v !== '');
            if (col.type === 'number') {
                const nums = values.map(v => parseFloat(v));
                kpis.push({ id: id++, title: `Total ${col.name}`, type:'number', value: nums.reduce((a,b)=>a+b,0).toFixed(2), source:{ column: col.name, operation:'sum'}});
                kpis.push({ id: id++, title: `Moyenne ${col.name}`, type:'number', value: (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2), source:{ column: col.name, operation:'avg'}});
            }
            if (col.type === 'category') {
                const counts = {};
                values.forEach(v => counts[v] = (counts[v]||0)+1);
                const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
                kpis.push({ id:id++, title:`Distribution ${col.name}`, type:'list', value:sorted.slice(0,10), source:{ column: col.name, operation:'distribution'}});
            }
        });
        kpis.push({id:id++, title:'Nombre total de lignes', type:'number', value: dataRows.length, source:{operation:'count'}});
        return kpis;
    };

    const applyTemplateToData = (templateBlocks, newData) => {
        return templateBlocks.map(block => ({
            ...block,
            value: calculateKPI({ column: block.source?.column, operation: block.source?.operation, type:block.type }, newData)
        }));
    };

    const handleFileUpload = (e) => {
        const uploadedFile = e.target.files[0];
        if(!uploadedFile) return;
        setError(null); setSuccessMessage(null);

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const fileData = new Uint8Array(event.target.result);
                const workbook = XLSX.read(fileData, { type:'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                if(jsonData.length===0){ setError("Fichier vide"); return; }

                const cols = Object.keys(jsonData[0]);
                setData(jsonData); setColumns(cols); setFile(uploadedFile);

                // Si un template est chargé → appliquer
                if(template){
                    const newBlocks = applyTemplateToData(template.blocks, jsonData);
                    setBlocks(newBlocks);
                    setSuccessMessage(`✅ Template appliqué ! ${newBlocks.length} KPIs recalculés.`);
                } else {
                    // Sinon, génération automatique
                    const generatedKPIs = generateKPIs(jsonData, cols);
                    setBlocks(generatedKPIs);
                }
            } catch(err){
                setError("Erreur : " + err.message);
            }
        };
        reader.readAsArrayBuffer(uploadedFile);
    };

    const handleLoadTemplate = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (event)=>{
            try {
                const templateData = JSON.parse(event.target.result);
                setTemplate(templateData);
                setSuccessMessage('✅ Template chargé !');
                setTimeout(()=>setSuccessMessage(null), 4000);

                // Appliquer immédiatement si des données sont déjà uploadées
                if(data.length>0){
                    const newBlocks = applyTemplateToData(templateData.blocks, data);
                    setBlocks(newBlocks);
                    setSuccessMessage(`✅ Template appliqué ! ${newBlocks.length} KPIs recalculés.`);
                }
            } catch(err){
                setError("Erreur template");
            }
        };
        reader.readAsText(file);
    };

    const handleDelete = () => {
        if(selectedBlock!==null){
            setBlocks(blocks.filter(b=>b.id!==selectedBlock));
            setSelectedBlock(null);
        }
    };

    const handleModify = () => {
        const block = blocks.find(b=>b.id===selectedBlock);
        if(!block) return;
        setFormData({
            title:block.title,
            type:block.type,
            column:block.source?.column || columns[0] || '',
            operation:block.source?.operation || 'sum'
        });
        setShowModifyPanel(true);
    };

    const handleSaveModify = () => {
        if(!formData.title || !formData.column){ setError("Titre et colonne requis"); return; }
        const value = calculateKPI(formData);
        const newBlock = {
            id:selectedBlock,
            title:formData.title,
            type:formData.type,
            value:value,
            source:{ column:formData.column, operation:formData.operation }
        };
        setBlocks(blocks.map(b=>b.id===selectedBlock?newBlock:b));
        setShowModifyPanel(false);
        setSelectedBlock(null);
        setError(null);
    };

    const handleAdd = () => {
        setFormData({ title:'', type:'number', column:columns[0]||'', operation:'sum' });
        setShowAddPanel(true);
    };

    const handleSaveAdd = () => {
        if(!formData.title || !formData.column){ setError("Titre et colonne requis"); return; }
        const value = calculateKPI(formData);
        const newBlock = { id: blocks.length>0?Math.max(...blocks.map(b=>b.id))+1:0, title:formData.title, type:formData.type, value:value, source:{ column:formData.column, operation:formData.operation } };
        setBlocks([...blocks,newBlock]);
        setShowAddPanel(false);
        setError(null);
    };

    const handleSaveTemplate = () => {
        const templateData = { name:`Template ${new Date().toLocaleDateString()}`, timestamp:new Date().toISOString(), blocks:blocks.map(b=>({ id:b.id, title:b.title, type:b.type, source:b.source })), expectedColumns:columns };
        setTemplate(templateData);

        const blob = new Blob([JSON.stringify(templateData,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='dashboard-template.json'; a.click();

        setSuccessMessage('✅ Template sauvegardé !');
        setTimeout(()=>setSuccessMessage(null),4000);
    };

    const renderBlock = (block)=>{
        const isSelected = selectedBlock===block.id;
        if(block.type==='number'){
            return <div key={block.id} onClick={()=>setSelectedBlock(block.id)} className={`bg-white p-6 rounded-lg border-2 cursor-pointer transition-all hover:shadow-lg ${isSelected?'border-blue-500 shadow-lg scale-105':'border-gray-200'}`}>
                <div className="text-sm text-gray-500 mb-2">{block.title}</div>
                <div className="text-3xl font-bold text-gray-800">{block.value}</div>
            </div>
        }
        if(block.type==='list'){
            return <div key={block.id} onClick={()=>setSelectedBlock(block.id)} className={`bg-white p-6 rounded-lg border-2 cursor-pointer transition-all hover:shadow-lg ${isSelected?'border-blue-500 shadow-lg scale-105':'border-gray-200'}`}>
                <div className="text-sm text-gray-500 mb-3">{block.title}</div>
                {block.value.slice(0,8).map(([key,val],i)=>{
                    const maxVal = Math.max(...block.value.map(v=>parseFloat(v[1])));
                    const width = (parseFloat(val)/maxVal)*100;
                    return <div key={i} className="mb-3">
                        <div className="flex justify-between text-xs mb-1">
                            <span className="text-gray-600 truncate max-w-[120px]">{key}</span>
                            <span className="font-medium text-gray-800">{val}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div className="bg-blue-500 h-2 rounded-full" style={{width:`${width}%`}} />
                        </div>
                    </div>
                })}
            </div>
        }
    };

    const renderFormPanel = (isModify)=>(
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-lg w-full">
                <h2 className="text-2xl font-bold mb-6">{isModify?'Modifier':'Ajouter'}</h2>
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium mb-2">Titre</label>
                        <input type="text" value={formData.title} onChange={(e)=>setFormData({...formData,title:e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Type</label>
                        <select value={formData.type} onChange={(e)=>setFormData({...formData,type:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                            <option value="number">Nombre</option>
                            <option value="list">Liste</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Colonne</label>
                        <select value={formData.column} onChange={(e)=>setFormData({...formData,column:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                            {columns.map(col=><option key={col} value={col}>{col}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-2">Opération</label>
                        <select value={formData.operation} onChange={(e)=>setFormData({...formData,operation:e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                            <option value="sum">Somme</option>
                            <option value="avg">Moyenne</option>
                            <option value="max">Maximum</option>
                            <option value="min">Minimum</option>
                            <option value="count">Comptage</option>
                            <option value="distribution">Distribution</option>
                        </select>
                    </div>
                </div>
                <div className="flex gap-3 mt-6">
                    <button onClick={isModify?handleSaveModify:handleSaveAdd} className="flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600">OK</button>
                    <button onClick={()=>{ isModify?setShowModifyPanel(false):setShowAddPanel(false); }} className="flex-1 bg-gray-300 px-4 py-3 rounded-lg">Annuler</button>
                </div>
            </div>
        </div>
    );

    return
